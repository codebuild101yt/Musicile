<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess the Song</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #guessing-container {
            display: none;
        }
        #hint-text {
            display: none;
        }
        #try-again-btn {
            display: none;
        }
    </style>
</head>
<body class="bg-dark text-light">

    <div class="container py-5">
        <h1 class="text-center mb-4">Guess the Song</h1>

        <div class="d-flex justify-content-center">
            <button id="play-btn" class="btn btn-primary btn-lg">Play Song</button>
        </div>

        <div id="guessing-container" class="mt-4">
            <h2 class="text-center">Guess the Song!</h2>
            <div id="choices-container" class="d-flex justify-content-center mt-3"></div>
            <p id="guess-feedback" class="text-center mt-3"></p>
            <p id="tries-left" class="text-center">Tries left: 3</p>
            <div class="text-center mt-3">
                <button id="hint-btn" class="btn btn-warning">Get Hint</button>
            </div>
            <p id="hint-text" class="text-center mt-3"></p>
            <div class="text-center mt-3">
                <button id="try-again-btn" class="btn btn-danger">Try Again</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentSong = {}; // Store the current song data for guessing
        let hintGiven = false; // Track whether the hint has been shown
        let triesLeft = 3; // Number of tries the user has
        let hintStage = 0; // Track the stage of the hint (more specific on each incorrect guess)
        let previewTime = 2000; // Initial preview time (2 seconds)
        let audio = null; // Audio element to play the preview
        let songOptions = []; // List of song options to choose from

        // Fetch the daily song from the backend when the button is clicked
        document.getElementById('play-btn').addEventListener('click', async function(event) {
            event.preventDefault(); // Prevent page reload

            // Check if the user has already played today
            if (localStorage.getItem('guessedCorrectlyToday')) {
                alert('You have already played today. Come back tomorrow!');
                return; // Stop the game from starting
            }

            try {
                const button = document.getElementById('play-btn');
                button.style.display = 'none'; // Hide the Play button during the guessing phase

                // Fetch the song data from the server
                const response = await fetch('http://localhost:3000/daily-song');
                if (!response.ok) {
                    throw new Error('Failed to fetch song');
                }

                const songData = await response.json();
                console.log("Received song data:", songData); // Debugging

                // If no preview URL exists, skip this song and fetch another
                if (!songData.preview_url) {
                    alert("Song has no preview, skipping...");
                    return; // Skip to the next song
                }

                // Store song data for later guessing
                currentSong = songData;

                // Fetch multiple song options (for the sake of the demo, we'll use 3 other random songs)
                songOptions = await getSongOptions(currentSong.id); // Get 3 random options

                // Include the correct song in the options
                songOptions.push(currentSong);
                shuffleArray(songOptions); // Shuffle to randomize the options

                // Play the preview
                playSongPreview(songData.preview_url);

                // Display the choices
                displayChoices(songOptions);

                // Show the guessing form
                document.getElementById('guessing-container').style.display = 'block';

                // Reset hint visibility
                hintGiven = false;
                hintStage = 0;
                document.getElementById('hint-text').style.display = 'none';
                document.getElementById('tries-left').textContent = `Tries left: ${triesLeft}`;

            } catch (error) {
                console.error('Error fetching the daily song:', error);
                alert('Failed to fetch song.');
            }
        });

        // Handle the user's choice
        function handleChoice(selectedSong, index) {
            const feedbackElement = document.getElementById('guess-feedback');
            if (selectedSong.id === currentSong.id) {
                feedbackElement.textContent = 'Correct! You guessed the right song!';
                feedbackElement.classList.add('text-success');
                feedbackElement.classList.remove('text-danger');

                // Store in localStorage to prevent further play today
                localStorage.setItem('guessedCorrectlyToday', new Date().toDateString());

                // Allow retry after a correct guess, but stop further game play
                setTimeout(() => {
                    resetGame();
                    document.getElementById('play-btn').style.display = 'none'; // Hide the Play button
                }, 2000); // Wait 2 seconds before resetting
            } else {
                triesLeft--; // Decrease tries left
                feedbackElement.textContent = `Incorrect. Try again!`;
                feedbackElement.classList.add('text-danger');
                feedbackElement.classList.remove('text-success');

                if (triesLeft === 0) {
                    feedbackElement.textContent = 'Game over! You ran out of tries.';
                    setTimeout(() => resetGame(), 2000); // Wait 2 seconds before resetting
                } else {
                    previewTime += 5000; // Increase preview time by 5 seconds after an incorrect guess
                    playSongPreview(currentSong.preview_url); // Replay song with increased preview time
                }
            }
            document.getElementById('tries-left').textContent = `Tries left: ${triesLeft}`;

            // Disable further choices after a selection
            disableChoices();

            // If no tries left, disable hint button as well
            if (triesLeft === 0) {
                document.getElementById('hint-btn').disabled = true;
            }
            // Show the "Try Again" button after an incorrect guess
            document.getElementById('try-again-btn').style.display = 'inline-block';
        }

        // Reset the game to allow retrying, without resetting tries left
        function resetGame(isTryAgain = false) {
            // Only reset the tries left if it's not a "Try Again" action
            if (!isTryAgain) {
                triesLeft = 3;
            }

            hintStage = 0;
            document.getElementById('guess-feedback').textContent = '';
            document.getElementById('hint-text').style.display = 'none';
            document.getElementById('tries-left').textContent = `Tries left: ${triesLeft}`;
            enableChoices();
            document.getElementById('hint-btn').disabled = false;
            document.getElementById('try-again-btn').style.display = 'none';
            document.getElementById('play-btn').style.display = 'block'; // Show the Play button again after resetting
        }

        // Fetch random songs to create multiple-choice options
        async function getSongOptions(currentSongId) {
            const response = await fetch('http://localhost:3000/random-songs'); // Endpoint to fetch random songs
            const randomSongs = await response.json();

            // Filter out the current song from the options to avoid it appearing twice
            return randomSongs.filter(song => song.id !== currentSongId).slice(0, 3);
        }

        // Shuffle the options array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        // Play the preview of the song for a given time duration
        function playSongPreview(previewUrl) {
            if (audio) {
                audio.pause(); // Stop the previous song if any
            }

            audio = new Audio(previewUrl);
            audio.play();
            setTimeout(() => audio.pause(), previewTime);
        }

        // Display the song choices for the user to select
        function displayChoices(options) {
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = ''; // Clear any existing choices

            options.forEach((option, index) => {
                const choiceButton = document.createElement('button');
                choiceButton.textContent = option.name;
                choiceButton.classList.add('btn', 'btn-secondary', 'm-2');
                choiceButton.addEventListener('click', () => handleChoice(option, index));
                choicesContainer.appendChild(choiceButton);
            });
        }

        // Disable all choice buttons after a selection
        function disableChoices() {
            const buttons = document.querySelectorAll('#choices-container .btn');
            buttons.forEach(button => button.disabled = true);
        }

        // Enable all choice buttons
        function enableChoices() {
            const buttons = document.querySelectorAll('#choices-container .btn');
            buttons.forEach(button => button.disabled = false);
        }

        // Handle hint button click
        document.getElementById('hint-btn').addEventListener('click', function() {
            let hint = '';
            if (hintStage === 0) {
                hint = `It's by a well-known artist.`;
                hintStage++;
            } else if (hintStage === 1) {
                hint = `The song was released in ${currentSong.release_date.split('-')[0]}.`;
                hintStage++;
            } else if (hintStage === 2) {
                hint = `The song belongs to the genre: ${currentSong.genre}.`;
                hintStage++;
            } else {
                hint = 'No more hints available!';
                document.getElementById('hint-btn').disabled = true; // Disable hint button after all hints
            }
            document.getElementById('hint-text').textContent = hint;
            document.getElementById('hint-text').style.display = 'block';
        });

        // Handle Try Again button click
        document.getElementById('try-again-btn').addEventListener('click', function() {
            resetGame(true); // Reset game without resetting tries left
        });
    </script>
</body>
</html>
